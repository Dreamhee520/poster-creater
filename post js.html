<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 转 JSON (获奖名单) - 支持多奖次</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body {
            background-color: #f4f7f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 1000px;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="file"] {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: #5cb85c;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .file-label:hover {
            background-color: #4cae4c;
        }
        #fileInfo {
            margin-top: 10px;
            color: #666;
            font-style: italic;
        }
        .mapping-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .mapping-item {
            flex: 1;
            min-width: 200px;
        }
        select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #0275d8;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #025aa5;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .preview-container {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            overflow-x: auto;
            display: block;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .data-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        .action-buttons button {
            width: auto;
            padding: 10px 30px;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .tips {
            background-color: #d9edf7;
            color: #31708f;
            border-left: 4px solid #31708f;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .json-preview {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            max-height: 300px;
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Excel 转 JSON 工具 (多奖次版)</h1>
        <p style="text-align: center; color: #666;">将包含多奖次的获奖名单 Excel 文件转换为项目所需的 JSON 格式。</p>
        
        <div class="form-group">
            <label for="excelFile">步骤 1: 选择 Excel 文件</label>
            <input type="file" id="excelFile" accept=".xlsx, .xls">
            <label for="excelFile" class="file-label">选择文件</label>
            <div id="fileInfo">未选择文件</div>
            <div class="tips">
                <strong>格式要求：</strong> Excel 文件可包含姓名、学院、作品名称、奖次。第一行将被视为表头。
            </div>
        </div>

        <div id="mappingSection" class="form-group" style="display: none;">
            <label>步骤 2: 列映射</label>
            <p>请将 Excel 中的列与 JSON 字段进行匹配：</p>
            <div class="mapping-container">
                <div class="mapping-item">
                    <label for="nameColumn">姓名</label>
                    <select id="nameColumn"></select>
                </div>
                <div class="mapping-item">
                    <label for="collegeColumn">学院</label>
                    <select id="collegeColumn"></select>
                </div>
                <div class="mapping-item">
                    <label for="workColumn">作品名称</label>
                    <select id="workColumn"></select>
                </div>
                <!-- 新增：奖次列映射 -->
                <div class="mapping-item">
                    <label for="awardColumn">奖次 (可选)</label>
                    <select id="awardColumn"></select>
                </div>
            </div>
            <button id="generateBtn">步骤 3: 生成 JSON</button>
        </div>

        <div id="jsonPreviewContainer" class="preview-container" style="display: none;">
            <h2>JSON 预览与导出</h2>
            <p>生成的 JSON 文件已准备好。点击下方按钮下载。</p>
            <div id="jsonPreview" class="json-preview"></div>
            <div class="action-buttons">
                <button id="downloadBtn">下载 JSON 文件</button>
                <button id="resetBtn">重新开始</button>
            </div>
            <div id="status"></div>
        </div>
    </div>

    <!-- 引入SheetJS库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="text/javascript">
        // DOM元素
        const excelFileInput = document.getElementById('excelFile');
        const fileInfo = document.getElementById('fileInfo');
        const mappingSection = document.getElementById('mappingSection');
        const nameColumnSelect = document.getElementById('nameColumn');
        const collegeColumnSelect = document.getElementById('collegeColumn');
        const workColumnSelect = document.getElementById('workColumn');
        const awardColumnSelect = document.getElementById('awardColumn'); // 新增
        const generateBtn = document.getElementById('generateBtn');
        const jsonPreviewContainer = document.getElementById('jsonPreviewContainer');
        const jsonPreview = document.getElementById('jsonPreview');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const statusDiv = document.getElementById('status');

        let excelData = null;
        let generatedJson = null;

        // 文件选择事件
        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            fileInfo.textContent = `已选择: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[worksheetName];
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (excelData.length > 0) {
                        populateColumnSelects(excelData[0]);
                        mappingSection.style.display = 'block';
                        showStatus('Excel文件解析成功！请进行列映射。', 'success');
                    } else {
                        showStatus('错误：Excel文件中没有数据。', 'error');
                    }
                } catch (error) {
                    showStatus(`解析错误: ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // 填充列映射下拉框
        function populateColumnSelects(headers) {
            [nameColumnSelect, collegeColumnSelect, workColumnSelect, awardColumnSelect].forEach(select => {
                select.innerHTML = '';
                // 新增：添加“不映射”选项
                const noneOption = new Option("不映射", "-1");
                select.add(noneOption);
            });

            headers.forEach((header, index) => {
                const optionText = header ? `${header} (列 ${index + 1})` : `列 ${index + 1}`;
                const option = new Option(optionText, index);
                nameColumnSelect.add(option.cloneNode(true));
                collegeColumnSelect.add(option.cloneNode(true));
                workColumnSelect.add(option.cloneNode(true));
                awardColumnSelect.add(option.cloneNode(true)); // 新增
            });
        }

        // 生成JSON按钮点击事件
        generateBtn.addEventListener('click', function() {
            if (!excelData || excelData.length <= 1) {
                showStatus('错误：没有可处理的数据。', 'error');
                return;
            }

            const nameIdx = parseInt(nameColumnSelect.value);
            const collegeIdx = parseInt(collegeColumnSelect.value);
            const workIdx = parseInt(workColumnSelect.value);
            const awardIdx = parseInt(awardColumnSelect.value); // 新增

            const tableData = [];
            let currentAwardType = "一等奖"; // 默认奖项
            
            // 遍历数据行
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                if (!row[nameIdx] && !row[collegeIdx] && !row[workIdx]) continue;
                if (!row[nameIdx] || !row[workIdx]) {
                    console.warn(`跳过第 ${i+1} 行：姓名或作品名称为空。`);
                    continue;
                }

                // 新增：处理奖次
                let rowAwardType = currentAwardType; // 默认使用当前奖次
                if (awardIdx !== -1 && row[awardIdx]) { // 如果映射了奖次列且有值
                    rowAwardType = row[awardIdx].trim();
                }

                // 如果当前行的奖次与上一组不同，则创建新的section
                if (tableData.length === 0 || rowAwardType !== currentAwardType) {
                    currentAwardType = rowAwardType;
                    tableData.push({ type: 'section', text: currentAwardType });
                }

                // 添加数据行
                tableData.push({
                    type: 'data',
                    values: [
                        row[nameIdx] || '',
                        row[collegeIdx] || '',
                        row[workIdx] || ''
                    ]
                });
            }
            
            if (tableData.length === 0) {
                showStatus('警告：未找到有效数据行。', 'error');
                return;
            }

            generatedJson = {
                tableData: tableData,
                styleConfig: {
                    tableWidth: 80, nameWidth: 20, collegeWidth: 25, workWidth: 55,
                    rowHeight: 10, contentSize: 16, headerSize: 18, awardSize: 18,
                    contentColor: '#FFB886', fontFamily: "'FZKai', 'STKaiti', serif",
                    borderSize: 3, borderColor: '#FFD700'
                },
                saveTime: new Date().toLocaleString()
            };

            jsonPreview.textContent = JSON.stringify(generatedJson, null, 2);
            jsonPreviewContainer.style.display = 'block';
            jsonPreview.style.display = 'block';
            jsonPreview.scrollIntoView({ behavior: 'smooth' });
            showStatus('JSON文件生成成功！', 'success');
        });

        // 下载和重置按钮事件 (与之前版本相同)
        downloadBtn.addEventListener('click', function() {
            if (!generatedJson) { showStatus('错误：没有可下载的JSON数据。', 'error'); return; }
            const jsonString = JSON.stringify(generatedJson, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `获奖名单_${new Date().getTime()}.json`;
            document.body.appendChild(a); a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
            showStatus('JSON文件已开始下载！', 'success');
        });

        resetBtn.addEventListener('click', function() {
            excelFileInput.value = ''; fileInfo.textContent = '未选择文件';
            mappingSection.style.display = 'none'; jsonPreviewContainer.style.display = 'none';
            jsonPreview.textContent = ''; generatedJson = null; statusDiv.style.display = 'none';
        });

        function showStatus(message, type) {
            statusDiv.textContent = message; statusDiv.className = type; statusDiv.style.display = 'block';
            if (type !== 'error') setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html>